{#
# This file is part of Invenio.
# Copyright (C) 2016 CERN.
#
# Invenio is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation; either version 2 of the
# License, or (at your option) any later version.
#
# Invenio is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Invenio; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
#
# In applying this license, CERN does not
# waive the privileges and immunities granted to it by virtue of its status
# as an Intergovernmental Organization or submit itself to any jurisdiction.
#}

{%- extends config.DEPOSIT_BASE_TEMPLATE %}

{%- block css %}
    {% assets "invenio_deposit_css" %}<link href="{{ ASSET_URL }}" rel="stylesheet">{% endassets %}
    {{ super() }}
{%- endblock css %}

{%- block javascript %}
  <script type="text/javascript">
    // CKEDITOR static location
    window.CKEDITOR_BASEPATH = '{{url_for("static", filename="node_modules/ckeditor/", _external=True)}}';
  </script>
  {% assets "cds_deposit_jquery_js" %}<script src="{{ ASSET_URL }}"></script>{% endassets %}
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular-sanitize.js"></script>
  {% assets "cds_deposit_js" %}<script src="{{ ASSET_URL }}"></script>{% endassets %}
  <script type="text/javascript">
    function cdsDepositsConfig($locationProvider) {
      $locationProvider.html5Mode({
        enabled: true,
        requireBase: false,
        rewriteLinks: false,
      });
    }

    // Inject the necessary angular services
    cdsDepositsConfig.$inject = ['$locationProvider'];

  function cdsDepositsCtrl($http, $q, $scope, $window, $location) {
    var that = this;
    this.edit = false;
    var master = this.master = {};
    var children = this.children = [];

    this.$onInit = function() {
      if (this.masterLinks) {
        this.edit = true;
        // GO fetch one by
        this.JSONResolver(this.masterLinks.self)
          .then(function(response) {
            that.master = response.data;
            // FIXME: resolve all the children
            that.masterInit = true;
          });
      }
    }

    this.fileReducer = function(file) {
     return {
       key: file.name,
       uri: false,
     };
    }

    this.reducer = function(deposit, files) {
      angular.forEach(this.fileReducer(files), function(value, key) {
         files[key] = value;
       });
      return angular.merge(
        {},
        deposit,
        {
          files: [files]
        }
      );
    }

    this.addMaster = function(deposit, files) {
      if (!this.masterInit) {
        this.master = this.reducer(deposit, files);
        this.masterInit = true;
        if (this.master.links.html) {
          this.handleRedirect(this.master.links.html, true);
        }
      };
    };

    this.addChildren = function(deposit, files) {
      this.children.push(
        this.reducer(deposit, files)
      );
    };

    this.initDeposit = function(files) {
      // add some proper logic to dinstiguish files
      // first create master
      this.createDeposit(this.init, this.masterSchema)
        .then(function(response) {
          // Create the master
          that.addMaster(response.data, files.pop());
          var master_id = response.data.metadata._deposit.id;
          // for each files create child
          angular.forEach(files, function(file, index) {
            that.createDeposit(that.init, that.childrenSchema)
              .then(function(response) {
                response.data.metadata._deposit.project_id = master_id;
                that.addChildren(response.data, file);
              });
          });
        });
    }

    this.createDeposit = function(url, schema) {
      return $http({
        url: url,
        method: 'POST',
        data: {
          $schema: schema
        }
      });
    };

    this.makeAction = function(url, method, payload) {
      return $http({
        url: url,
        method: method,
        data: payload
      });
    };

    this.chainedActions = function(promises) {
      var defer = $q.defer();
      var data = [];
      function _chain(fn) {
        fn().then(
          function(_data) {
            data.push(_data);
            if (promises.length > 0) {
              return _chain(promises.shift());
            } else {
              defer.resolve(data);
            }
          }, function(error) {
            defer.reject(error);
          }
        );
      }
      _chain(promises.shift());
      return defer.promise;
    };

    this.handleRedirect = function(url, replace) {
      if (!angular.isUndefined(url) && url !== '') {
        if (replace) {
          // ¯\_(ツ)_/¯ https://github.com/angular/angular.js/issues/3924
          var parser = document.createElement('a');
          parser.href = url;
          $location.url(parser.pathname);
          $location.replace();
        } else {
          $window.location.href = url;
        }
      }
    }

    this.JSONResolver = function(url) {
      return $http.get(url);
    };

    // Meessages Success
    $scope.$on('cds.deposit.success', function(evt, response) {
      console.info('Success', response);
    });
    // Meessages Error
    $scope.$on('cds.deposit.error', function(evt, response) {
      console.info('Error', response);
    });
    // Loading Start
    $scope.$on('cds.loading.start', function(evt) {
      console.info('Loading started');
    });
    // Loading Stopped
    $scope.$on('cds.loading.end', function(evt) {
      console.info('Loading stopped');
    });
  }

  function cdsDeposits() {
    return {
      transclude: true,
      bindings: {
        init: '@',
        // master related
        masterLinks: '<',
        masterSchema: '@',
        masterForm: '@',
        // children related
        childrenForm: '@',
        childrenSchema: '@',
        // general template base
        templatesBase: '='
      },
      controller: cdsDepositsCtrl,
      templateUrl: function($element, $attrs) {
        return $attrs.template;
      }
    }
  };

  function cdsDeposit() {
    return {
      transclude: true,
      bindings: {
        master: '@',
        // Interface related
        updateRecordAfterSuccess: '@',
        // Deposit related
        schema: '@',
        record: '=',
        links: '=',
      },
      require: {
        cdsDepositsCtrl: '^cdsDeposits'
      },
      controller: function($scope) {
        var that = this;
        this.$onInit = function() {
          // Resolve the record schema
          this.cdsDepositsCtrl.JSONResolver(this.schema)
            .then(function(response) {
              that.schema = response.data;
            });
        }

        this.guessEndpoint = function(endpoint) {
          if (Object.keys(that.links).indexOf(endpoint) > -1) {
            return that.links[endpoint];
          }
          return endpoint;
        };

        // Do a single action at once
        this.makeSingleAction = function(endpoint, method, redirect) {
          // Guess the endpoint
          var url = this.guessEndpoint(endpoint);
          return this.cdsDepositsCtrl
            .makeAction(url, method, that.record);
        }

        // Do multiple actions at once
        this.makeMultipleActions = function(actions, redirect) {
          var promises = [];
          angular.forEach(actions, function(action, index) {
            var url = that.guessEndpoint(action[0]);
            this.push(function() {
              return that.cdsDepositsCtrl.makeAction(url, action[1], that.record);
            });
          }, promises);
          return that.cdsDepositsCtrl.chainedActions(promises);
        }

        this.postSuccessProcess = function(responses) {
          // Get only the latest response (in case of multiple actions)
          var response = (responses[responses.length - 1] || responses).data;
          // Update record
          if (this.updateRecordAfterSuccess) {
            this.record = response.metadata;
          }
          // Update links
          if (this.updateLinksAfterSuccess) {
            this.links = response.links;
          }
        }

        this.postErrorProcess = function(responses) {
          // Process errors
        }

        this.onSuccessAction = function(response) {
          // Post success process
          that.postSuccessProcess(response);
          // Inform the parents
          $scope.$emit('cds.deposit.success', response);
        }

        this.onErrorAction = function(response) {
          // Post error process
          that.postErrorProcess(response);
          // Inform the parents
          $scope.$emit('cds.deposit.error', response);
        }
      },
      template: "<div ng-transclude></div>"
    };
  }

  function cdsForm() {
    return {
      bindings: {
        form: '@',
      },
      require: {
        cdsDepositCtrl: '^cdsDeposit'
      },
      controller: function($http, schemaFormDecorators) {
        var that = this;
        this.$onInit = function() {
          this.cdsDepositCtrl.cdsDepositsCtrl.JSONResolver(this.form)
            .then(function(response) {
              that.form = response.data;
            });
        };
      },
      templateUrl: function($element, $attrs) {
        return $attrs.template;
      }
    }
  }

  function cdsActions() {
    return {
      bindings: {
      },
      require: {
        cdsDepositCtrl: '^cdsDeposit'
      },
      controller: function() {
        var that = this;
        this.$onInit = function() {
          this.actionHandler = function(type, method) {
            that.cdsDepositCtrl.makeSingleAction(type, method)
                .then(
                  that.cdsDepositCtrl.onSuccessAction,
                  that.cdsDepositCtrl.onErrorAction
                );
          }
          this.actionMultipleHandler = function(actions) {
            that.cdsDepositCtrl.makeMultipleActions(actions)
                .then(
                  that.cdsDepositCtrl.onSuccessAction,
                  that.cdsDepositCtrl.onErrorAction
                );
          }
        }
      },
      templateUrl: function($element, $attrs) {
        return $attrs.template;
      }
    }
  }

  function cdsUploader() {
    return {
      bindings: {
        files: '=',
        links: '=',
      },
      require: {
        cdsDepositCtrl: '^cdsDeposit'
      },
      controller: function(InvenioFilesAPI, InvenioFilesUploaderModel) {
        var that = this;
        this.$onInit = function() {
          that.filesJS = JSON.stringify(that.files);
          that.linksJS = JSON.stringify(that.links);
          this.addFiles = function(files) {
            angular.forEach(files, function(file) {
              that.files.push(file);
            });
          }
        };
      },
      templateUrl: function($element, $attrs) {
        return $attrs.template;
      }
    }
  }





























    angular.element(document).ready(function() {

      angular.module('cdsDeposit', [
        'schemaForm', 'mgcrea.ngStrap',
        'mgcrea.ngStrap.modal', 'pascalprecht.translate', 'ui.sortable',
        'ui.select', 'mgcrea.ngStrap.select', 'mgcrea.ngStrap.datepicker',
        'mgcrea.ngStrap.helpers.dateParser', 'mgcrea.ngStrap.tooltip', 'invenioFiles'
      ])
      .config(cdsDepositsConfig)
      .component('cdsDeposits', cdsDeposits())
      .component('cdsForm', cdsForm())
      .component('cdsActions', cdsActions())
      .component('cdsUploader', cdsUploader())
      .component('cdsDeposit', cdsDeposit());

       app = angular.module('cdsDeposit').config(['schemaFormDecoratorsProvider', function(decoratorsProvider){
         decoratorsProvider.addMapping('bootstrapDecorator', 'ckeditor', '{{ url_for("static", filename="templates/cds_deposit/ckeditor.html")}}');
         decoratorsProvider.addMapping('bootstrapDecorator', 'uiselect', '{{ url_for("static", filename="templates/cds_deposit/uiselect.html")}}');
         decoratorsProvider.addMapping('bootstrapDecorator', 'fieldset', '{{ url_for("static", filename="node_modules/invenio-records-js/dist/fieldset.html")}}');
         {%- for key, value in config.DEPOSIT_FORM_TEMPLATES.iteritems() -%}
          {%- set file = "%s/%s"|format(config.DEPOSIT_FORM_TEMPLATES_BASE, value) -%}
          decoratorsProvider.addMapping('bootstrapDecorator', '{{key}}', '{{ url_for("static", filename=file) }}');
         {%- endfor -%}
       }]);

      angular.bootstrap(
        document.getElementById('cds-deposit'), ['cdsDeposit']
      );
    });
  </script>
{%- endblock javascript %}

{%- block page_body %}

  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <div id="cds-deposit">
        <cds-deposits
            {% if pid %}
              master-links='{{pid|tolinksjs(record)|tojson}}'
            {% else %}
              init="{{ config.DEPOSIT_SEARCH_API }}"
            {% endif %}
            master-schema="{{ url_for('invenio_jsonschemas.get_schema', schema_path=config.DEPOSIT_DEFAULT_JSONSCHEMA, _external=True) }}"
            master-form="{{ url_for('static', filename=config.DEPOSIT_DEFAULT_SCHEMAFORM) }}"
            children-schema="http://localhost:5000/schemas/deposits/records/video-v1.0.0.json"
            children-form="http://localhost:5000/static/json/cds_deposit/forms/video.json"
            template="{{ url_for('static', filename='templates/cds_deposit/deposits.html') }}"
            templatesBase="/static/templates/cds_deposit/"
        >
        </cds-deposits>
        {{record|tofilesjs|tojson}}
        </div>
      </div>
    </div>
  </div>
{%- endblock %}
